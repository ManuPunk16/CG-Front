<div class="w-full">
  <!-- Sección de filtros (opcional) -->
  <div *ngIf="showFilters" class="bg-gray-50 p-4 rounded-lg shadow-sm mb-6">
    <form [formGroup]="filterForm" class="grid grid-cols-1 gap-4">
      <!-- Dos filas separadas para evitar encimado en pantallas pequeñas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Área - usando primera columna completa en móviles -->
        <mat-form-field  class="w-full">
          <mat-label>Área</mat-label>
          <mat-select formControlName="area">
            <mat-option *ngFor="let area of availableAreas" [value]="area">{{ area }}</mat-option>
          </mat-select>
          <mat-error *ngIf="filterForm.get('area')?.hasError('required') && filterForm.get('area')?.touched">
            El área es obligatoria
          </mat-error>
          <mat-hint>Seleccione un área específica</mat-hint>
        </mat-form-field>

        <!-- Fecha inicial -->
        <mat-form-field  class="w-full">
          <mat-label>Fecha inicial</mat-label>
          <input matInput [matDatepicker]="startDatePicker" formControlName="fechaInicio">
          <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #startDatePicker></mat-datepicker>
          <mat-error *ngIf="filterForm.get('fechaInicio')?.hasError('required') && filterForm.get('fechaInicio')?.touched">
            La fecha inicial es obligatoria
          </mat-error>
        </mat-form-field>

        <!-- Fecha final -->
        <mat-form-field  class="w-full">
          <mat-label>Fecha final</mat-label>
          <input matInput [matDatepicker]="endDatePicker" formControlName="fechaFin">
          <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #endDatePicker></mat-datepicker>
          <mat-error *ngIf="filterForm.get('fechaFin')?.hasError('required') && filterForm.get('fechaFin')?.touched">
            La fecha final es obligatoria
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Agregar debajo de los campos de fecha -->
      <div *ngIf="filterForm.errors?.['dateRangeInvalid'] && (filterForm.get('fechaInicio')?.touched || filterForm.get('fechaFin')?.touched)"
           class="text-red-500 text-sm mt-1 col-span-full">
        La fecha final debe ser posterior a la fecha inicial
      </div>

      <!-- Botones en una fila aparte -->
      <div class="flex flex-wrap items-center justify-end gap-3">
        <button
          mat-raised-button
          color="primary"
          (click)="applyFilters()"
          [disabled]="filterForm.invalid || isLoading"
          class="min-w-[120px]">
          <mat-icon>search</mat-icon>
          <span class="ml-1">Aplicar</span>
        </button>
        <button
          mat-stroked-button
          (click)="resetFilters()"
          [disabled]="isLoading"
          class="min-w-[120px]">
          <mat-icon>refresh</mat-icon>
          <span class="ml-1">Limpiar</span>
        </button>
      </div>

      <!-- Mensaje de estado del formulario (opcional) -->
      <div *ngIf="filterForm.touched && filterForm.invalid" class="text-sm text-red-500 mt-2">
        Por favor, complete todos los campos requeridos antes de aplicar los filtros.
      </div>
    </form>
  </div>

  <!-- Spinner de carga -->
  <div *ngIf="isLoading" class="flex justify-center my-8">
    <mat-spinner [diameter]="40"></mat-spinner>
  </div>

  <!-- Mensaje inicial -->
  <div *ngIf="!isLoading && !tiemposRespuestaData && !estatusData && showFilters"
       class="bg-gray-50 p-8 rounded-lg text-center mb-6">
    <mat-icon class="text-gray-400 text-6xl mb-3">bar_chart</mat-icon>
    <h3 class="text-lg font-medium text-gray-700 mb-1">Seleccione un área y aplique filtros</h3>
    <p class="text-gray-500">Utilice los filtros de arriba para visualizar las estadísticas.</p>
  </div>

  <!-- Tarjetas de estadísticas -->
  <div *ngIf="!isLoading && tiemposRespuestaData" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total oficios -->
    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-blue-500 font-medium">Total Oficios</p>
          <h3 class="text-2xl font-bold text-blue-700">{{ totalOficios }}</h3>
        </div>
        <div class="bg-blue-100 p-2 rounded-full">
          <mat-icon class="text-blue-500">inventory_2</mat-icon>
        </div>
      </div>
    </div>

    <!-- Oficios atendidos -->
    <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-green-500 font-medium">Atendidos</p>
          <h3 class="text-2xl font-bold text-green-700">{{ oficiosAtendidos }}</h3>
        </div>
        <div class="bg-green-100 p-2 rounded-full">
          <mat-icon class="text-green-500">check_circle</mat-icon>
        </div>
      </div>
    </div>

    <!-- Oficios no atendidos -->
    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-red-500 font-medium">No Atendidos</p>
          <h3 class="text-2xl font-bold text-red-700">{{ oficiosNoAtendidos }}</h3>
        </div>
        <div class="bg-red-100 p-2 rounded-full">
          <mat-icon class="text-red-500">error</mat-icon>
        </div>
      </div>
    </div>

    <!-- Porcentaje de atención -->
    <div [ngClass]="getColorForPorcentaje(porcentajeAtencion)" class="p-4 rounded-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium" [ngClass]="getTextColorForPorcentaje(porcentajeAtencion)">% Atención</p>
          <h3 class="text-2xl font-bold" [ngClass]="getTextColorForPorcentaje(porcentajeAtencion)">
            {{ porcentajeAtencion }}%
          </h3>
        </div>
        <div class="p-2 rounded-full" [ngClass]="{'bg-green-100': porcentajeAtencion >= 80, 'bg-yellow-100': porcentajeAtencion >= 50 && porcentajeAtencion < 80, 'bg-red-100': porcentajeAtencion < 50}">
          <mat-icon [ngClass]="getTextColorForPorcentaje(porcentajeAtencion)">pie_chart</mat-icon>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedores de gráficos -->
  <div *ngIf="!isLoading" class="grid grid-cols-1 gap-6 mb-6">
    <!-- Gráfico de distribución por estatus -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h3 class="text-lg font-semibold mb-4">Distribución por Estatus</h3>
      <div [style.height]="height || '300px'" class="relative">
        <!-- Importante: asegurar que el canvas tenga id además de referencia template -->
        <canvas #estatusCanvas id="estatusCanvas"></canvas>
      </div>
    </div>

    <!-- Gráfico de tiempos de respuesta -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h3 class="text-lg font-semibold mb-4">Tiempos de Respuesta</h3>
      <div [style.height]="height || '300px'" class="relative">
        <!-- Importante: asegurar que el canvas tenga id además de referencia template -->
        <canvas #tiemposRespuestaCanvas id="tiemposRespuestaCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Tabla de oficios -->
  <ng-container *ngIf="!isLoading && tiemposRespuestaData?.datos_oficios?.length">
    <div class="mb-3">
      <h3 class="text-lg font-medium text-gray-900">Detalle de Oficios</h3>
      <p class="text-sm text-gray-500">Listado de los oficios que conforman la estadística</p>
    </div>

    <div class="overflow-x-auto bg-white shadow-sm rounded-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Núm. Oficio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estatus</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Recepción</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Respuesta</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Días</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let oficio of tiemposRespuestaData.datos_oficios">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ oficio.folio }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ oficio.num_oficio }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [ngClass]="oficio.estatus === 'ATENDIDO' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                {{ oficio.estatus }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ oficio.fecha_recepcion | date:'dd/MM/yyyy' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ oficio.tiempo_respuesta | date:'dd/MM/yyyy' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <span [ngClass]="{
                'text-green-600': oficio.categoria_tiempo === 'rapido',
                'text-blue-600': oficio.categoria_tiempo === 'normal',
                'text-amber-600': oficio.categoria_tiempo === 'lento',
                'text-red-600': oficio.categoria_tiempo === 'muy_lento'
              }">
                {{ oficio.diferencia_dias.toFixed(1) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [ngClass]="{
                      'bg-green-100 text-green-800': oficio.categoria_tiempo === 'rapido',
                      'bg-blue-100 text-blue-800': oficio.categoria_tiempo === 'normal',
                      'bg-amber-100 text-amber-800': oficio.categoria_tiempo === 'lento',
                      'bg-red-100 text-red-800': oficio.categoria_tiempo === 'muy_lento'
                    }">
                {{ oficio.categoria_tiempo === 'rapido' ? 'Rápido' :
                   oficio.categoria_tiempo === 'normal' ? 'Normal' :
                   oficio.categoria_tiempo === 'lento' ? 'Lento' : 'Muy Lento' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>

  <!-- Mensaje sin datos -->
  <div *ngIf="!isLoading && (!tiemposRespuestaData || tiemposRespuestaData.datos_oficios?.length === 0) && !showFilters"
       class="bg-gray-50 p-8 rounded-lg text-center">
    <mat-icon class="text-gray-400 text-6xl mb-3">bar_chart</mat-icon>
    <h3 class="text-lg font-medium text-gray-700 mb-1">Sin datos disponibles</h3>
    <p class="text-gray-500">No se encontraron registros para el área seleccionada.</p>
  </div>
</div>
