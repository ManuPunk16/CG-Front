<div class="bg-white rounded-lg shadow-md p-4 mb-6">
  <!-- Filtros y controles -->
  <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-5">
    <!-- Filtro de usuario -->
    <div class="md:col-span-3">
      <mat-form-field  class="w-full">
        <mat-label>Usuario</mat-label>
        <input matInput formControlName="username" placeholder="Buscar por usuario">
        <mat-icon matSuffix>person</mat-icon>
      </mat-form-field>
    </div>

    <!-- Fecha desde -->
    <div class="md:col-span-2">
      <mat-form-field  class="w-full">
        <mat-label>Desde</mat-label>
        <input matInput [matDatepicker]="pickerFrom" formControlName="fromDate">
        <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
        <mat-datepicker #pickerFrom></mat-datepicker>
      </mat-form-field>
    </div>

    <!-- Fecha hasta -->
    <div class="md:col-span-2">
      <mat-form-field  class="w-full">
        <mat-label>Hasta</mat-label>
        <input matInput [matDatepicker]="pickerTo" formControlName="toDate">
        <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
        <mat-datepicker #pickerTo></mat-datepicker>
      </mat-form-field>
    </div>

    <!-- Filtro de área (solo para admin/director) -->
    <div *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" class="md:col-span-2">
      <mat-form-field  class="w-full">
        <mat-label>Área</mat-label>
        <mat-select formControlName="area">
          <mat-option value="todas">Todas las áreas</mat-option>
          <mat-option *ngFor="let area of areas" [value]="area">{{ area }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Días para estadísticas (solo para admin/director) -->
    <div *ngIf="canViewStats()" class="md:col-span-2">
      <mat-form-field  class="w-full">
        <mat-label>Periodo (días)</mat-label>
        <mat-select formControlName="days">
          <mat-option [value]="7">Última semana</mat-option>
          <mat-option [value]="30">Último mes</mat-option>
          <mat-option [value]="90">Últimos 3 meses</mat-option>
          <mat-option [value]="365">Último año</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Botones de acción -->
    <div class="md:col-span-3 flex items-center gap-2">
      <button mat-raised-button color="primary" (click)="applyFilter()">
        <mat-icon>search</mat-icon>
        Filtrar
      </button>
      <button mat-stroked-button color="warn" (click)="resetFilter()">
        <mat-icon>clear</mat-icon>
        Limpiar
      </button>
      <button mat-stroked-button color="accent" (click)="exportToExcel()" matTooltip="Exportar resultados a Excel">
        <mat-icon>download</mat-icon>
      </button>
    </div>
  </form>

  <!-- Estadísticas y gráficos (solo para admin/director) -->
  <div *ngIf="canViewStats() && showCharts && stats" class="mb-8">
    <!-- Cards con totales -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-sm text-blue-500">Total Accesos</p>
            <h3 class="text-2xl font-bold text-blue-700">{{ stats.totals.logins }}</h3>
          </div>
          <div class="p-2 bg-blue-100 rounded-full">
            <mat-icon class="text-blue-500">login</mat-icon>
          </div>
        </div>
        <p class="text-xs text-blue-600 mt-2">En el periodo seleccionado</p>
      </div>

      <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-sm text-purple-500">Usuarios Activos</p>
            <h3 class="text-2xl font-bold text-purple-700">{{ stats.totals.uniqueUsers }}</h3>
          </div>
          <div class="p-2 bg-purple-100 rounded-full">
            <mat-icon class="text-purple-500">people</mat-icon>
          </div>
        </div>
        <p class="text-xs text-purple-600 mt-2">Usuarios con inicios de sesión</p>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Gráfico de accesos diarios -->
      <div class="bg-white p-4 rounded-lg border border-gray-200">
        <h4 class="text-lg font-medium mb-4">Accesos Diarios</h4>
        <div class="h-60">
          <!-- Cambiado: Usar #dailyChartCanvas en lugar de id -->
          <canvas #dailyChartCanvas></canvas>
        </div>
      </div>

      <!-- Gráfico de accesos por usuario -->
      <div class="bg-white p-4 rounded-lg border border-gray-200">
        <h4 class="text-lg font-medium mb-4">Top Usuarios</h4>
        <div class="h-60">
          <!-- Cambiado: Usar #userChartCanvas en lugar de id -->
          <canvas #userChartCanvas></canvas>
        </div>
      </div>
    </div>

    <!-- Gráfico de accesos por área -->
    <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
      <h4 class="text-lg font-medium mb-4">Accesos por Área</h4>
      <div class="h-60">
        <!-- Cambiado: Usar #areaChartCanvas en lugar de id -->
        <canvas #areaChartCanvas></canvas>
      </div>
    </div>
  </div>

  <!-- Tabla de logs -->
  <div class="mat-elevation-z1 relative">
    <!-- Spinner de carga -->
    <div *ngIf="isLoading" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-10">
      <mat-spinner [diameter]="40"></mat-spinner>
    </div>

    <!-- Mensaje sin resultados -->
    <div *ngIf="!isLoading && dataSource.data.length === 0" class="py-10 text-center">
      <mat-icon class="text-gray-400 text-5xl">search_off</mat-icon>
      <p class="text-gray-500 mt-2">No se encontraron registros de acceso</p>
    </div>

    <!-- Tabla de resultados -->
    <div *ngIf="!isLoading && dataSource.data.length > 0">
      <table mat-table [dataSource]="dataSource" matSort class="w-full">
        <!-- Nombre de Usuario -->
        <ng-container *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" matColumnDef="userName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Nombre </th>
          <td mat-cell *matCellDef="let log"> {{log.userName || 'N/A'}} </td>
        </ng-container>

        <!-- Username -->
        <ng-container *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Usuario </th>
          <td mat-cell *matCellDef="let log"> {{log.username}} </td>
        </ng-container>

        <!-- Área -->
        <ng-container *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" matColumnDef="area">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Área </th>
          <td mat-cell *matCellDef="let log"> {{log.userId?.area || 'N/A'}} </td>
        </ng-container>

        <!-- Fecha y hora -->
        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha y Hora </th>
          <td mat-cell *matCellDef="let log"> {{formatDate(log.timestamp)}} </td>
        </ng-container>

        <!-- Dirección IP -->
        <ng-container matColumnDef="ipAddress">
          <th mat-header-cell *matHeaderCellDef> Dirección IP </th>
          <td mat-cell *matCellDef="let log"> {{log.details?.ipAddress || 'N/A'}} </td>
        </ng-container>

        <!-- User Agent -->
        <ng-container matColumnDef="userAgent">
          <th mat-header-cell *matHeaderCellDef> Navegador </th>
          <td mat-cell *matCellDef="let log" [matTooltip]="log.details?.userAgent || 'N/A'">
            {{formatUserAgent(log.details?.userAgent)}}
          </td>
        </ng-container>

        <!-- Detalles (para usuario normal) -->
        <ng-container *ngIf="!(userPermissions?.isAdmin || userPermissions?.isDirectorGeneral)" matColumnDef="details">
          <th mat-header-cell *matHeaderCellDef> Detalles </th>
          <td mat-cell *matCellDef="let log">
            {{formatUserAgent(log.details?.userAgent)}}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- Paginador -->
      <mat-paginator
        [length]="totalLogs"
        [pageSize]="pageSize"
        [pageSizeOptions]="[5, 10, 25, 50]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  </div>
</div>
