<div class="w-full">
  <!-- Sección de filtros (opcional) -->
  <div *ngIf="showFilters" class="bg-[var(--neutral-50)] p-4 rounded-lg shadow-sm mb-6 border border-[var(--neutral-200)]">
    <form [formGroup]="filterForm" class="grid grid-cols-1 gap-4">
      <!-- Dos filas separadas para evitar encimado en pantallas pequeñas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Área - usando primera columna completa en móviles -->
        <div class="relative">
          <label for="area" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Área</label>
          <select
            id="area"
            formControlName="area"
            class="w-full px-4 py-2.5 text-[var(--text-primary)] bg-white border border-[var(--neutral-300)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-500)] appearance-none">
            <option [value]="''">Seleccione un área</option>
            <option *ngFor="let area of availableAreas" [value]="area">{{ area }}</option>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-2 pt-5 pointer-events-none">
            <svg class="w-5 h-5 text-[var(--neutral-500)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          <div *ngIf="filterForm.get('area')?.hasError('required') && filterForm.get('area')?.touched" class="text-[var(--error-600)] text-xs mt-1">
            El área es obligatoria
          </div>
          <div class="text-xs text-[var(--neutral-500)] mt-1">Seleccione un área específica</div>
        </div>

        <!-- Fecha inicial -->
        <div class="relative">
          <label for="fechaInicio" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Fecha inicial</label>
          <div class="relative">
            <input
              type="date"
              id="fechaInicio"
              formControlName="fechaInicio"
              class="w-full px-4 py-2.5 text-[var(--text-primary)] bg-white border border-[var(--neutral-300)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-500)]">
          </div>
          <div *ngIf="filterForm.get('fechaInicio')?.hasError('required') && filterForm.get('fechaInicio')?.touched" class="text-[var(--error-600)] text-xs mt-1">
            La fecha inicial es obligatoria
          </div>
        </div>

        <!-- Fecha final -->
        <div class="relative">
          <label for="fechaFin" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Fecha final</label>
          <div class="relative">
            <input
              type="date"
              id="fechaFin"
              formControlName="fechaFin"
              class="w-full px-4 py-2.5 text-[var(--text-primary)] bg-white border border-[var(--neutral-300)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-500)]">
          </div>
          <div *ngIf="filterForm.get('fechaFin')?.hasError('required') && filterForm.get('fechaFin')?.touched" class="text-[var(--error-600)] text-xs mt-1">
            La fecha final es obligatoria
          </div>
        </div>
      </div>

      <!-- Agregar debajo de los campos de fecha -->
      <div *ngIf="filterForm.errors?.['dateRangeInvalid'] && (filterForm.get('fechaInicio')?.touched || filterForm.get('fechaFin')?.touched)"
           class="text-[var(--error-600)] text-sm mt-1 col-span-full">
        La fecha final debe ser posterior a la fecha inicial
      </div>

      <!-- Botones en una fila aparte -->
      <div class="flex flex-wrap items-center justify-end gap-3">
        <button
          type="button"
          (click)="applyFilters()"
          [disabled]="filterForm.invalid || isLoading"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[var(--primary-600)] hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
          Aplicar
        </button>
        <button
          type="button"
          (click)="resetFilters()"
          [disabled]="isLoading"
          class="inline-flex items-center px-4 py-2 border border-[var(--neutral-300)] text-sm font-medium rounded-md shadow-sm text-[var(--text-primary)] bg-white hover:bg-[var(--neutral-50)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-300)] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
          </svg>
          Limpiar
        </button>
      </div>

      <!-- Mensaje de estado del formulario (opcional) -->
      <div *ngIf="filterForm.touched && filterForm.invalid" class="text-sm text-[var(--error-600)] mt-2">
        Por favor, complete todos los campos requeridos antes de aplicar los filtros.
      </div>
    </form>
  </div>

  <!-- Spinner de carga personalizado -->
  <div *ngIf="isLoading" class="flex justify-center my-8">
    <div class="spinner-container">
      <div class="spinner-border"></div>
      <span class="ml-3 text-[var(--text-secondary)]">Cargando datos...</span>
    </div>
  </div>

  <!-- Mensaje inicial -->
  <div *ngIf="!isLoading && !tiemposRespuestaData && !estatusData && showFilters"
       class="bg-[var(--neutral-50)] p-8 rounded-lg text-center mb-6 border border-[var(--neutral-200)]">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-[var(--neutral-400)] mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </svg>
    <h3 class="text-lg font-medium text-[var(--text-secondary)] mb-1">Seleccione un área y aplique filtros</h3>
    <p class="text-[var(--text-tertiary)]">Utilice los filtros de arriba para visualizar las estadísticas.</p>
  </div>

  <!-- Tarjetas de estadísticas -->
  <div *ngIf="!isLoading && tiemposRespuestaData" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total oficios -->
    <div class="bg-[var(--info-50)] border border-[var(--info-200)] p-4 rounded-lg shadow-sm transition-all hover:shadow-md">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[var(--info-600)] font-medium">Total Oficios</p>
          <h3 class="text-2xl font-bold text-[var(--info-700)]">{{ totalOficios }}</h3>
        </div>
        <div class="bg-[var(--info-100)] p-2.5 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[var(--info-500)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Oficios atendidos -->
    <div class="bg-[var(--success-50)] border border-[var(--success-200)] p-4 rounded-lg shadow-sm transition-all hover:shadow-md">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[var(--success-600)] font-medium">Atendidos</p>
          <h3 class="text-2xl font-bold text-[var(--success-700)]">{{ oficiosAtendidos }}</h3>
        </div>
        <div class="bg-[var(--success-100)] p-2.5 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[var(--success-500)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Oficios no atendidos -->
    <div class="bg-[var(--error-50)] border border-[var(--error-200)] p-4 rounded-lg shadow-sm transition-all hover:shadow-md">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-[var(--error-600)] font-medium">No Atendidos</p>
          <h3 class="text-2xl font-bold text-[var(--error-700)]">{{ oficiosNoAtendidos }}</h3>
        </div>
        <div class="bg-[var(--error-100)] p-2.5 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[var(--error-500)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Porcentaje de atención con colores dinámicos -->
    <div [ngClass]="getColorForPorcentaje(porcentajeAtencion)" class="p-4 rounded-lg shadow-sm transition-all hover:shadow-md">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium" [ngClass]="getTextColorForPorcentaje(porcentajeAtencion)">% Atención</p>
          <h3 class="text-2xl font-bold" [ngClass]="getTextColorForPorcentaje(porcentajeAtencion)">
            {{ porcentajeAtencion }}%
          </h3>
        </div>
        <div class="p-2.5 rounded-full"
             [ngClass]="{
               'bg-[var(--success-100)]': porcentajeAtencion >= 80,
               'bg-[var(--warning-100)]': porcentajeAtencion >= 50 && porcentajeAtencion < 80,
               'bg-[var(--error-100)]': porcentajeAtencion < 50
             }">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" [ngClass]="getTextColorForPorcentaje(porcentajeAtencion)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedores de gráficos -->
  <div *ngIf="!isLoading" class="grid grid-cols-1 gap-6 mb-6">
    <!-- Gráfico de distribución por estatus -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-[var(--neutral-200)] transition-all hover:shadow-md">
      <h3 class="text-lg font-semibold mb-4 text-[var(--text-primary)]">Distribución por Estatus</h3>
      <div [style.height]="height || '300px'" class="relative">
        <canvas #estatusCanvas id="estatusCanvas"></canvas>
      </div>
    </div>

    <!-- Gráfico de tiempos de respuesta -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-[var(--neutral-200)] transition-all hover:shadow-md">
      <h3 class="text-lg font-semibold mb-4 text-[var(--text-primary)]">Tiempos de Respuesta</h3>
      <div [style.height]="height || '300px'" class="relative">
        <canvas #tiemposRespuestaCanvas id="tiemposRespuestaCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Tabla de oficios mejorada -->
  <ng-container *ngIf="!isLoading && tiemposRespuestaData?.datos_oficios?.length">
    <div class="mb-3">
      <h3 class="text-lg font-medium text-[var(--text-primary)]">Detalle de Oficios</h3>
      <p class="text-sm text-[var(--text-tertiary)]">Listado de los oficios que conforman la estadística</p>
    </div>

    <div class="overflow-x-auto bg-white shadow-sm rounded-lg border border-[var(--neutral-200)]">
      <table class="min-w-full divide-y divide-[var(--neutral-200)]">
        <thead class="bg-[var(--neutral-50)]">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Folio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Núm. Oficio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Estatus</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Fecha Recepción</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Fecha Respuesta</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Días</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Categoría</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-[var(--neutral-200)]">
          <tr *ngFor="let oficio of tiemposRespuestaData.datos_oficios" class="hover:bg-[var(--neutral-50)] transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-[var(--text-primary)]">{{ oficio.folio }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">{{ oficio.num_oficio }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [ngClass]="oficio.estatus === 'ATENDIDO' ? 'bg-[var(--success-100)] text-[var(--success-800)]' : 'bg-[var(--error-100)] text-[var(--error-800)]'">
                {{ oficio.estatus }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">{{ oficio.fecha_recepcion | date:'dd/MM/yyyy' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">{{ oficio.tiempo_respuesta | date:'dd/MM/yyyy' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <span [ngClass]="{
                'text-[var(--success-600)]': oficio.categoria_tiempo === 'rapido',
                'text-[var(--info-600)]': oficio.categoria_tiempo === 'normal',
                'text-[var(--warning-600)]': oficio.categoria_tiempo === 'lento',
                'text-[var(--error-600)]': oficio.categoria_tiempo === 'muy_lento'
              }">
                {{ oficio.diferencia_dias.toFixed(1) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [ngClass]="{
                      'bg-[var(--success-100)] text-[var(--success-800)]': oficio.categoria_tiempo === 'rapido',
                      'bg-[var(--info-100)] text-[var(--info-800)]': oficio.categoria_tiempo === 'normal',
                      'bg-[var(--warning-100)] text-[var(--warning-800)]': oficio.categoria_tiempo === 'lento',
                      'bg-[var(--error-100)] text-[var(--error-800)]': oficio.categoria_tiempo === 'muy_lento'
                    }">
                {{ oficio.categoria_tiempo === 'rapido' ? 'Rápido' :
                   oficio.categoria_tiempo === 'normal' ? 'Normal' :
                   oficio.categoria_tiempo === 'lento' ? 'Lento' : 'Muy Lento' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>

  <!-- Mensaje sin datos -->
  <div *ngIf="!isLoading && (!tiemposRespuestaData || tiemposRespuestaData.datos_oficios?.length === 0) && !showFilters"
       class="bg-[var(--neutral-50)] p-8 rounded-lg text-center border border-[var(--neutral-200)]">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-[var(--neutral-400)] mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </svg>
    <h3 class="text-lg font-medium text-[var(--text-secondary)] mb-1">Sin datos disponibles</h3>
    <p class="text-[var(--text-tertiary)]">No se encontraron registros para el área seleccionada.</p>
  </div>
</div>
