<div class="w-full">
  <!-- Encabezado y controles -->
  <div class="flex flex-wrap items-center justify-between mb-6">
    <!-- Buscador de usuarios optimizado con Tailwind -->
    <div class="flex-grow mr-4 mb-3 sm:mb-0">
      <div class="relative">
        <input
          type="text"
          (keyup)="applyFilter($event)"
          placeholder="Buscar por nombre, email, área..."
          #input
          class="w-full px-4 py-2.5 pr-10 border border-[var(--neutral-300)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-400)] transition-colors bg-[var(--background-contrast)] text-[var(--text-primary)]"
        >
        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--neutral-500)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Botón para crear nuevo usuario -->
    <button
      (click)="openCreateDialog()"
      class="inline-flex items-center px-4 py-2.5 text-sm font-medium rounded-md shadow-sm bg-[var(--primary-500)] hover:bg-[var(--primary-600)] text-[var(--text-light)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-400)] transition-colors"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Nuevo Usuario
    </button>
  </div>

  <!-- Indicador de carga personalizado -->
  <div *ngIf="isLoading" class="flex justify-center p-8">
    <div class="w-10 h-10 rounded-full border-4 border-[var(--primary-300)] border-t-[var(--primary-600)] animate-spin"></div>
    <span class="ml-3 text-[var(--text-secondary)]">Cargando usuarios...</span>
  </div>

  <!-- Contenedor de la tabla con estilos Tailwind -->
  <div class="bg-[var(--background-contrast)] rounded-lg shadow-sm overflow-hidden border border-[var(--neutral-200)]" [class.opacity-50]="isLoading">
    <!-- Aquí mantenemos la tabla de Material -->
    <div class="overflow-x-auto">
      <table mat-table [dataSource]="dataSource" matSort class="w-full">
        <!-- Username Column -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-6 py-3 bg-[var(--neutral-50)] text-left text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">
            Usuario
          </th>
          <td mat-cell *matCellDef="let user" class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-primary)]">
            <div class="flex items-center">
              <div class="h-8 w-8 rounded-full bg-[var(--primary-100)] flex items-center justify-center mr-2">
                <span class="text-xs font-medium text-[var(--primary-700)]">{{user.username.charAt(0).toUpperCase()}}</span>
              </div>
              <span>{{user.username}}</span>
            </div>
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-6 py-3 bg-[var(--neutral-50)] text-left text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">
            Email
          </th>
          <td mat-cell *matCellDef="let user" class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">
            {{user.email}}
          </td>
        </ng-container>

        <!-- Área Column -->
        <ng-container matColumnDef="area">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-6 py-3 bg-[var(--neutral-50)] text-left text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">
            Área
          </th>
          <td mat-cell *matCellDef="let user" class="px-6 py-4 whitespace-normal break-words max-w-xs text-sm text-[var(--text-secondary)]">
            {{user.area}}
          </td>
        </ng-container>

        <!-- Role Column -->
        <ng-container matColumnDef="roles">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-6 py-3 bg-[var(--neutral-50)] text-left text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">
            Rol
          </th>
          <td mat-cell *matCellDef="let user" class="px-6 py-4 whitespace-nowrap text-sm">
            <span class="px-2 py-1 text-xs rounded-full font-medium"
                  [ngClass]="{
                    'bg-[var(--tertiary-100)] text-[var(--tertiary-800)]': user.roles === 'administrador',
                    'bg-[var(--info-100)] text-[var(--info-800)]': user.roles === 'enlace',
                    'bg-[var(--success-100)] text-[var(--success-800)]': user.roles === 'director',
                    'bg-[var(--secondary-100)] text-[var(--secondary-800)]': user.roles === 'director_general'
                  }">
              {{user.roles}}
            </span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="active">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-6 py-3 bg-[var(--neutral-50)] text-left text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">
            Estado
          </th>
          <td mat-cell *matCellDef="let user" class="px-6 py-4 whitespace-nowrap text-sm">
            <span class="px-2 py-1 text-xs rounded-full font-medium"
                  [ngClass]="{
                    'bg-[var(--success-100)] text-[var(--success-800)]': user.active,
                    'bg-[var(--error-100)] text-[var(--error-800)]': !user.active
                  }">
              {{user.active ? 'Activo' : 'Inactivo'}}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="px-6 py-3 bg-[var(--neutral-50)] text-left text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wider">
            Acciones
          </th>
          <td mat-cell *matCellDef="let user" class="px-6 py-4 whitespace-nowrap">
            <div class="flex space-x-3">
              <!-- Botón Editar -->
              <button
                (click)="openEditDialog(user)"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full text-[var(--primary-600)] hover:bg-[var(--primary-50)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-200)] transition-colors"
                title="Editar usuario"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>

              <!-- Botón Cambiar contraseña -->
              <button
                (click)="openResetPasswordDialog(user)"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full text-[var(--secondary-600)] hover:bg-[var(--secondary-50)] focus:outline-none focus:ring-2 focus:ring-[var(--secondary-200)] transition-colors"
                title="Cambiar contraseña"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
              </button>

              <!-- Botón Activar/Desactivar -->
              <button
                (click)="confirmToggleStatus(user)"
                class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors"
                [class]="user.active ? 'text-[var(--error-600)] hover:bg-[var(--error-50)] focus:ring-[var(--error-200)]' : 'text-[var(--success-600)] hover:bg-[var(--success-50)] focus:ring-[var(--success-200)]'"
                [title]="user.active ? 'Desactivar usuario' : 'Activar usuario'"
              >
                <svg *ngIf="user.active" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                <svg *ngIf="!user.active" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="border-b border-[var(--neutral-200)]"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            [ngClass]="{'bg-[var(--neutral-50)]': !row.active}"
            class="border-b border-[var(--neutral-200)] transition-colors hover:bg-[var(--neutral-50)]"></tr>

        <!-- Fila para cuando no hay datos -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell py-16 text-center" [attr.colspan]="displayedColumns.length">
            <div class="flex flex-col items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-[var(--neutral-400)] mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" />
              </svg>
              <p *ngIf="input.value; else noData" class="text-[var(--text-tertiary)]">
                No se encontraron usuarios para "{{input.value}}"
              </p>
              <ng-template #noData>
                <p class="text-[var(--text-tertiary)]">No hay usuarios registrados</p>
              </ng-template>
              <button
                *ngIf="input.value"
                (click)="clearFilter(input)"
                class="mt-4 px-4 py-2 text-sm rounded-md border border-[var(--neutral-300)] text-[var(--text-secondary)] hover:bg-[var(--neutral-100)] transition-colors"
                >
                Limpiar búsqueda
              </button>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <!-- Mantenemos el paginador de Material -->
    <mat-paginator
      [pageSizeOptions]="[10, 25, 50]"
      showFirstLastButtons
      aria-label="Seleccionar página de usuarios"
      class="border-t border-[var(--neutral-200)] bg-[var(--neutral-50)]">
    </mat-paginator>
  </div>
</div>
