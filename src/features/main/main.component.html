<div class="w-full px-2 sm:px-4 py-4">
  <!-- Encabezado y filtros -->
  <div class="bg-white shadow-md rounded-lg overflow-hidden mb-4">
    <div class="px-4 py-3 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-50">
      <div class="mb-2 sm:mb-0">
        <h1 class="text-xl font-semibold text-gray-800">Registros de Entradas</h1>
        <p class="text-sm text-gray-500">Información del año <span class="font-medium">{{ currentYear }}</span></p>
      </div>
      <div class="flex gap-2">
        <button mat-raised-button color="primary" (click)="crearNuevoRegistro()">
          <mat-icon>add</mat-icon>
          Nuevo Registro
        </button>
      </div>
    </div>

    <div class="px-4 py-3 bg-white">
      <div class="mb-2">
        <h2 class="text-md font-medium text-gray-700 mb-2">Filtros de búsqueda</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
          <!-- Filtro por folio -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Folio</mat-label>
            <input matInput [(ngModel)]="filterValues['folio']" placeholder="Buscar por folio">
          </mat-form-field>

          <!-- Filtro por fecha_recepcion -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Fecha de Recepción</mat-label>
            <input matInput [(ngModel)]="filterValues['fecha_recepcion']" placeholder="dd/mm/yyyy">
            <mat-hint>Formato: dd/mm/yyyy</mat-hint>
          </mat-form-field>

          <!-- Filtro por num_oficio -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Núm. Oficio</mat-label>
            <input matInput [(ngModel)]="filterValues['num_oficio']" placeholder="Buscar por oficio">
          </mat-form-field>

          <!-- Filtro por institucion_origen con Autocomplete -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Institución</mat-label>
            <input type="text"
                   placeholder="Buscar institución"
                   matInput
                   [formControl]="institutionFilterControl"
                   [matAutocomplete]="autoInst">
            <mat-autocomplete #autoInst="matAutocomplete" [displayWith]="displayInstitution">
              <mat-option *ngIf="isLoadingInstitutions" class="loading-option">
                <mat-spinner diameter="20"></mat-spinner>
                Cargando...
              </mat-option>
              <mat-option *ngIf="filteredInstitutions.length === 0 && !isLoadingInstitutions" disabled>
                No se encontraron resultados
              </mat-option>
              <mat-option *ngFor="let option of filteredInstitutions" [value]="option.name">
                {{ option.name }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <!-- Filtro por remitente -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Remitente</mat-label>
            <input matInput [(ngModel)]="filterValues['remitente']" placeholder="Buscar por remitente">
          </mat-form-field>

          <!-- Filtro por asunto -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Asunto</mat-label>
            <input matInput [(ngModel)]="filterValues['asunto']" placeholder="Buscar por asunto">
          </mat-form-field>

          <!-- Filtro por asignado -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Asignado</mat-label>
            <mat-select [(ngModel)]="filterValues['asignado']">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let area of areas" [value]="area">{{ area }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Filtro por estatus -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Estatus</mat-label>
            <mat-select [(ngModel)]="filterValues['estatus']">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let status of statusOptions" [value]="status">{{ status }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="flex flex-wrap gap-2 mt-2">
          <button mat-raised-button color="primary" (click)="applyFilters()">
            <mat-icon>search</mat-icon>
            Buscar
          </button>
          <button mat-stroked-button (click)="clearFilters()">
            <mat-icon>clear_all</mat-icon>
            Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de datos con Material -->
  <div class="mat-elevation-z8 rounded-lg overflow-hidden">
    <!-- Loading overlay -->
    <div *ngIf="isLoadingResults" class="flex justify-center items-center absolute inset-0 bg-white bg-opacity-80 z-10">
      <mat-spinner diameter="48"></mat-spinner>
    </div>

    <!-- Tabla Material - Contenedor con responsive -->
    <div class="w-full overflow-x-auto">
      <table mat-table [dataSource]="dataSource" matSort (matSortChange)="announceSortChange($event)"
             class="w-full min-w-full table-fixed">

        <!-- Columna de acciones -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="w-20 sm:w-24"> Acciones </th>
          <td mat-cell *matCellDef="let item">
            <div class="flex space-x-1">
              <button mat-icon-button color="primary" (click)="verDetalles(item)" matTooltip="Ver detalles">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="editarSeguimiento(item)" matTooltip="Editar seguimiento">
                <mat-icon>assignment</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Columna de folio con color según estatus -->
        <ng-container matColumnDef="folio">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-16 sm:w-20"> Folio </th>
          <td mat-cell *matCellDef="let item">
            <div class="flex items-center">
              <span [ngClass]="{
                'text-green-600 font-medium': item.estatus === 'ATENDIDO',
                'text-red-600 font-medium': item.estatus === 'NO ATENDIDO',
                'text-gray-600': item.estatus !== 'ATENDIDO' && item.estatus !== 'NO ATENDIDO'
              }">
                {{item.folio}}
              </span>
              <!-- Opcional: añadir un pequeño indicador visual -->
              <span *ngIf="item.estatus === 'ATENDIDO'" class="ml-2 w-2 h-2 rounded-full bg-green-500" title="Atendido"></span>
              <span *ngIf="item.estatus === 'NO ATENDIDO'" class="ml-2 w-2 h-2 rounded-full bg-red-500" title="No atendido"></span>
            </div>
          </td>
        </ng-container>

        <!-- Columna de fecha de recepción -->
        <ng-container matColumnDef="fecha_recepcion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-32 sm:w-36"> Fecha Recepción </th>
          <td mat-cell *matCellDef="let item"> {{item.fecha_recepcion | date:'dd/MM/yyyy'}} </td>
        </ng-container>

        <!-- Columna de días atraso -->
        <ng-container matColumnDef="diasAtraso">
          <th mat-header-cell *matHeaderCellDef class="w-24 sm:w-28"> Días Atraso </th>
          <td mat-cell *matCellDef="let item">
            <div class="flex items-center">
              <span [class]="item.colorSemaforo" class="w-3 h-3 rounded-full mr-2"></span>
              <span>{{ getDiasAtrasoText(item) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Columna de número de oficio -->
        <ng-container matColumnDef="num_oficio">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-28 sm:w-32"> Núm. Oficio </th>
          <td mat-cell *matCellDef="let item"> {{item.num_oficio}} </td>
        </ng-container>

        <!-- Columna de institución origen -->
        <ng-container matColumnDef="institucion_origen">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-36 sm:w-40"> Institución </th>
          <td mat-cell *matCellDef="let item" class="break-words"> {{item.institucion_origen}} </td>
        </ng-container>

        <!-- Columna de remitente -->
        <ng-container matColumnDef="remitente">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-36 sm:w-40"> Remitente </th>
          <td mat-cell *matCellDef="let item" class="break-words"> {{item.remitente}} </td>
        </ng-container>

        <!-- Columna de asunto - CON BREAK TEXT -->
        <ng-container matColumnDef="asunto">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Asunto </th>
          <td mat-cell *matCellDef="let item" class="break-words whitespace-normal py-4"> {{item.asunto}} </td>
        </ng-container>

        <!-- Columna de asignado -->
        <ng-container matColumnDef="asignado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-32 sm:w-36"> Asignado </th>
          <td mat-cell *matCellDef="let item" class="break-words"> {{item.asignado}} </td>
        </ng-container>

        <!-- Columna de atención otorgada -->
        <ng-container matColumnDef="atencion_otorgada">
          <th mat-header-cell *matHeaderCellDef class="w-40 sm:w-48"> Atención </th>
          <td mat-cell *matCellDef="let item" class="break-words whitespace-normal py-4">
            {{item.atencion_otorgada_visual}}
          </td>
        </ng-container>

        <!-- Columna de estatus -->
        <!-- <ng-container matColumnDef="estatus">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-28 sm:w-32"> Estatus </th>
          <td mat-cell *matCellDef="let item">
            <mat-chip-row color="primary" highlighted *ngIf="item.estatus === 'ATENDIDO'">
              Atendido
            </mat-chip-row>
            <mat-chip-row color="warn" highlighted *ngIf="item.estatus === 'NO ATENDIDO'">
              No atendido
            </mat-chip-row>
            <mat-chip-row *ngIf="item.estatus !== 'ATENDIDO' && item.estatus !== 'NO ATENDIDO'">
              {{ item.estatus }}
            </mat-chip-row>
          </td>
        </ng-container> -->

        <!-- Filas con estilos condicionales -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" [ngClass]="getRowClass(row)"></tr>

        <!-- Fila para cuando no hay datos -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center py-4" [attr.colspan]="displayedColumns.length">
            No se encontraron registros que coincidan con los criterios de búsqueda
          </td>
        </tr>
      </table>
    </div>

    <!-- Paginador Material -->
    <mat-paginator
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      [showFirstLastButtons]="true"
      aria-label="Selecciona una página">
    </mat-paginator>
  </div>
</div>
