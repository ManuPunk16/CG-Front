<div class="bg-[var(--background-contrast)] rounded-lg shadow-md p-5 mb-6">
  <!-- Filtros y controles -->
  <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-5">
    <!-- Filtro de usuario -->
    <div class="md:col-span-3">
      <label for="username" class="block text-xs font-medium text-[var(--text-tertiary)] mb-1.5">Usuario</label>
      <div class="relative">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--neutral-500)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <input
          id="username"
          type="text"
          formControlName="username"
          placeholder="Buscar por usuario"
          class="w-full pl-10 pr-4 py-2 border border-[var(--neutral-300)] rounded-md text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-400)] transition-colors"
        >
      </div>
    </div>

    <!-- Fecha desde -->
    <div class="md:col-span-2">
      <label for="fromDate" class="block text-xs font-medium text-[var(--text-tertiary)] mb-1.5">Desde</label>
      <div class="relative">
        <input
          id="fromDate"
          type="date"
          formControlName="fromDate"
          class="w-full px-3 py-2 border border-[var(--neutral-300)] rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-400)] transition-colors"
        >
      </div>
    </div>

    <!-- Fecha hasta -->
    <div class="md:col-span-2">
      <label for="toDate" class="block text-xs font-medium text-[var(--text-tertiary)] mb-1.5">Hasta</label>
      <div class="relative">
        <input
          id="toDate"
          type="date"
          formControlName="toDate"
          class="w-full px-3 py-2 border border-[var(--neutral-300)] rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-400)] transition-colors"
        >
      </div>
    </div>

    <!-- Filtro de área (solo para admin/director) -->
    <div *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" class="md:col-span-2">
      <label for="area" class="block text-xs font-medium text-[var(--text-tertiary)] mb-1.5">Área</label>
      <select
        id="area"
        formControlName="area"
        class="w-full px-3 py-2 border border-[var(--neutral-300)] bg-white rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-400)] transition-colors appearance-none"
      >
        <option value="todas">Todas las áreas</option>
        <option *ngFor="let area of areas" [value]="area">{{ area }}</option>
      </select>
      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--neutral-500)]">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- Días para estadísticas (solo para admin/director) -->
    <div *ngIf="canViewStats()" class="md:col-span-2">
      <label for="days" class="block text-xs font-medium text-[var(--text-tertiary)] mb-1.5">Periodo (días)</label>
      <select
        id="days"
        formControlName="days"
        class="w-full px-3 py-2 border border-[var(--neutral-300)] bg-white rounded-md text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-300)] focus:border-[var(--primary-400)] transition-colors appearance-none"
      >
        <option [value]="7">Última semana</option>
        <option [value]="30">Último mes</option>
        <option [value]="90">Últimos 3 meses</option>
        <option [value]="365">Último año</option>
      </select>
      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--neutral-500)]">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="md:col-span-3 flex items-center gap-2">
      <button
        type="button"
        (click)="applyFilter()"
        class="flex items-center px-3 py-2 rounded-md bg-[var(--primary-500)] text-[var(--text-light)] hover:bg-[var(--primary-600)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-400)] focus:ring-offset-2 transition-colors"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        Filtrar
      </button>
      <button
        type="button"
        (click)="resetFilter()"
        class="flex items-center px-3 py-2 rounded-md border border-[var(--error-300)] text-[var(--error-600)] hover:bg-[var(--error-50)] focus:outline-none focus:ring-2 focus:ring-[var(--error-200)] focus:ring-offset-2 transition-colors"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        Limpiar
      </button>
      <button
        type="button"
        (click)="exportToExcel()"
        class="flex items-center px-3 py-2 rounded-md border border-[var(--tertiary-300)] text-[var(--tertiary-600)] hover:bg-[var(--tertiary-50)] focus:outline-none focus:ring-2 focus:ring-[var(--tertiary-200)] focus:ring-offset-2 transition-colors"
        title="Exportar resultados a Excel"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
      </button>
    </div>
  </form>

  <!-- Estadísticas y gráficos (solo para admin/director) -->
  <div *ngIf="canViewStats() && showCharts && stats" class="mb-8">
    <!-- Cards con totales -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-[var(--info-50)] p-4 rounded-lg border border-[var(--info-200)]">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-sm text-[var(--info-600)]">Total Accesos</p>
            <h3 class="text-2xl font-bold text-[var(--info-700)]">{{ stats.totals.logins }}</h3>
          </div>
          <div class="p-2 bg-[var(--info-100)] rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--info-600)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-[var(--info-600)] mt-2">En el periodo seleccionado</p>
      </div>

      <div class="bg-[var(--tertiary-50)] p-4 rounded-lg border border-[var(--tertiary-200)]">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-sm text-[var(--tertiary-600)]">Usuarios Activos</p>
            <h3 class="text-2xl font-bold text-[var(--tertiary-700)]">{{ stats.totals.uniqueUsers }}</h3>
          </div>
          <div class="p-2 bg-[var(--tertiary-100)] rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--tertiary-600)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          </div>
        </div>
        <p class="text-xs text-[var(--tertiary-600)] mt-2">Usuarios con inicios de sesión</p>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Gráfico de accesos diarios -->
      <div class="bg-[var(--background-contrast)] p-4 rounded-lg border border-[var(--neutral-200)]">
        <h4 class="text-lg font-medium text-[var(--text-primary)] mb-4">Accesos Diarios</h4>
        <div class="h-60">
          <canvas #dailyChartCanvas></canvas>
        </div>
      </div>

      <!-- Gráfico de accesos por usuario -->
      <div class="bg-[var(--background-contrast)] p-4 rounded-lg border border-[var(--neutral-200)]">
        <h4 class="text-lg font-medium text-[var(--text-primary)] mb-4">Top Usuarios</h4>
        <div class="h-60">
          <canvas #userChartCanvas></canvas>
        </div>
      </div>
    </div>

    <!-- Gráfico de accesos por área -->
    <div class="bg-[var(--background-contrast)] p-4 rounded-lg border border-[var(--neutral-200)] mb-6">
      <h4 class="text-lg font-medium text-[var(--text-primary)] mb-4">Accesos por Área</h4>
      <div class="h-60">
        <canvas #areaChartCanvas></canvas>
      </div>
    </div>
  </div>

  <!-- Tabla de logs con arreglo para el sort -->
  <div class="relative border border-[var(--neutral-200)] rounded-lg overflow-hidden">
    <!-- Spinner de carga -->
    <div *ngIf="isLoading" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-10">
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 border-4 border-[var(--primary-300)] border-t-[var(--primary-600)] rounded-full animate-spin"></div>
        <span class="text-[var(--text-secondary)]">Cargando datos...</span>
      </div>
    </div>

    <!-- Mensaje sin resultados -->
    <div *ngIf="!isLoading && dataSource.data.length === 0" class="py-16 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-[var(--neutral-400)] mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" />
      </svg>
      <p class="text-[var(--text-tertiary)]">No se encontraron registros de acceso</p>
      <button
        (click)="resetFilter()"
        class="mt-4 px-4 py-2 bg-[var(--neutral-50)] text-[var(--text-secondary)] hover:bg-[var(--neutral-100)] border border-[var(--neutral-300)] rounded-md transition-colors text-sm"
      >
        Limpiar filtros
      </button>
    </div>

    <div *ngIf="!isLoading && dataSource.data.length > 0">
      <table mat-table
             [dataSource]="dataSource"
             matSort
             [matSortActive]="sortActive"
             [matSortDirection]="sortDirection"
             (matSortChange)="sortData($event)"
             class="w-full">

        <!-- Nombre de Usuario -->
        <ng-container *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" matColumnDef="userName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header disableClear> Usuario </th>
          <td mat-cell *matCellDef="let log"> {{log.userName || 'N/A'}} </td>
        </ng-container>

        <!-- Área -->
        <ng-container *ngIf="userPermissions?.isAdmin || userPermissions?.isDirectorGeneral" matColumnDef="area">
          <th mat-header-cell *matHeaderCellDef mat-sort-header disableClear> Área </th>
          <td mat-cell *matCellDef="let log" class="truncate"> {{log.userId?.area || 'N/A'}} </td>
        </ng-container>

        <!-- Fecha y hora -->
        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef mat-sort-header disableClear> Fecha y Hora </th>
          <td mat-cell *matCellDef="let log"> {{formatDate(log.timestamp)}} </td>
        </ng-container>

        <!-- Dirección IP -->
        <ng-container matColumnDef="ipAddress">
          <th mat-header-cell *matHeaderCellDef> Dirección IP </th>
          <td mat-cell *matCellDef="let log"> {{log.details?.ipAddress || 'N/A'}} </td>
        </ng-container>

        <!-- User Agent -->
        <ng-container matColumnDef="userAgent">
          <th mat-header-cell *matHeaderCellDef> Navegador </th>
          <td mat-cell *matCellDef="let log" [title]="log.details?.userAgent || 'N/A'" class="truncate">
            {{formatUserAgent(log.details?.userAgent)}}
          </td>
        </ng-container>

        <!-- Detalles (para usuario normal) -->
        <ng-container *ngIf="!(userPermissions?.isAdmin || userPermissions?.isDirectorGeneral)" matColumnDef="details">
          <th mat-header-cell *matHeaderCellDef> Detalles </th>
          <td mat-cell *matCellDef="let log" class="truncate">
            {{formatUserAgent(log.details?.userAgent)}}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"
          class="bg-[var(--neutral-50)] border-b border-[var(--neutral-200)]"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          class="hover:bg-[var(--neutral-50)] transition-colors duration-200 border-b border-[var(--neutral-200)]"></tr>
      </table>

      <div class="mat-paginator-container border-t border-[var(--neutral-200)] bg-[var(--neutral-50)]">
        <mat-paginator
          [length]="totalLogs"
          [pageSize]="pageSize"
          [pageIndex]="currentPage"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons
          class="paginator-fix">
        </mat-paginator>
      </div>
    </div>
  </div>
</div>
